<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradeOps Mobile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { primary: '#2563EB', secondary: '#475569', surface: '#F8FAFC', success: '#10B981' }
        }
      }
    }
  </script>
  <style>[v-cloak]{display:none;}</style>
</head>
<body class="bg-surface text-slate-800 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col" v-cloak>
  <!-- TOASTS -->
  <div class="fixed top-3 right-3 z-[60] space-y-2 w-[92vw] max-w-sm md:w-80 toast-container">
    <div v-for="n in notifications" :key="n.id"
         class="rounded-xl shadow-xl border p-3 bg-white flex items-start gap-3">
      <div class="mt-0.5" :class="n.type==='success'?'text-green-600':(n.type==='error'?'text-red-600':'text-blue-600')">
        <i class="fa-solid" :class="n.type==='success'?'fa-circle-check':(n.type==='error'?'fa-triangle-exclamation':'fa-circle-info')"></i>
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-bold text-slate-800">{{ n.title }}</div>
        <div class="text-xs text-slate-500 mt-0.5 break-words">{{ n.message }}</div>
      </div>
      <button @click="dismissToast(n.id)" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>

  <!-- LOGIN (unchanged UI) -->
  <div v-if="!user" class="fixed inset-0 bg-slate-100 z-50 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
      <div class="text-center mb-6">
        <div class="w-12 h-12 bg-primary text-white rounded-lg flex items-center justify-center mx-auto text-xl mb-2">
          <i class="fa-solid fa-bolt"></i>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">TradeOps Login</h1>
        <p class="text-sm text-slate-500">Enter your credentials</p>
      </div>
      <form @submit.prevent="login">
        <input v-model="loginForm.username" class="w-full border p-3 rounded-lg mb-3" placeholder="Username (admin / tech)">
        <input v-model="loginForm.password" type="password" class="w-full border p-3 rounded-lg mb-4" placeholder="Password">
        <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-600 transition">
          Sign In
        </button>
        <p class="text-xs text-slate-400 mt-3 text-center">
          Demo users: <span class="font-bold">admin/admin</span>, <span class="font-bold">tech/tech</span>
        </p>
      </form>
    </div>
  </div>

  <div v-else class="flex h-full relative">

    <!-- SIDEBAR (kept; adds Service Calls + Account Details routes without removing existing) -->
    <aside :class="mobileMenu ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
           class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 z-40 transition-transform duration-300 md:relative md:flex flex-col shadow-xl md:shadow-none">
      <div class="h-16 flex items-center px-6 border-b border-slate-100 justify-between">
        <div class="flex items-center font-bold text-lg tracking-tight">
          <span class="text-primary mr-2"><i class="fa-solid fa-bolt"></i></span> TradeOps
        </div>
        <button @click="mobileMenu=false" class="md:hidden text-slate-400"><i class="fa-solid fa-times"></i></button>
      </div>

      <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
        <a href="#" @click="setView('dashboard')" :class="navClass('dashboard')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
          <i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard
        </a>

        <template v-if="user.role === 'admin'">
          <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Management</div>

          <a href="#" @click="setView('dispatch')" :class="navClass('dispatch')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-calendar-days w-5 text-center"></i> Dispatch Board
          </a>

          <a href="#" @click="setView('workorders')" :class="navClass('workorders')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-clipboard-list w-5 text-center"></i> Work Orders
          </a>

          <!-- NEW: Service Calls list (does not remove Dispatch; complements it) -->
          <a href="#" @click="setView('service-calls')" :class="navClass('service-calls')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-wrench w-5 text-center"></i> Service Calls
          </a>

          <a href="#" @click="setView('quotes')" :class="navClass('quotes')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> Quotes
          </a>

          <a href="#" @click="setView('builder')" :class="navClass('builder')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-pen-ruler w-5 text-center"></i> Builder
          </a>

          <a href="#" @click="setView('accounts')" :class="navClass('accounts')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-users w-5 text-center"></i> Customers
          </a>
        </template>

        <template v-if="user.role === 'tech'">
          <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Field Work</div>
          <a href="#" @click="setView('my-schedule')" :class="navClass('my-schedule')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-calendar-check w-5 text-center"></i> My Schedule
          </a>

          <a href="#" @click="setView('workorders')" :class="navClass('workorders')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
            <i class="fa-solid fa-clipboard-list w-5 text-center"></i> Work Orders
          </a>
        </template>
      </nav>

      <div class="p-4 border-t border-slate-100 flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">
          {{ user.full_name.charAt(0) }}
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-sm truncate">{{ user.full_name }}</div>
          <div class="text-xs text-slate-400 capitalize">{{ user.role }}</div>
        </div>
        <button @click="logout" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-sign-out"></i></button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 flex flex-col h-full overflow-hidden w-full">
      <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm shrink-0 z-10">
        <div class="flex items-center gap-3">
          <button @click="mobileMenu = true" class="md:hidden text-slate-600 text-xl"><i class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg font-bold text-slate-800 capitalize">{{ view.replace('-', ' ') }}</h1>
        </div>

        <!-- NEW: Quick actions (no removals) -->
        <div v-if="user.role==='admin'" class="flex items-center gap-2">
          <button @click="openServiceCallModal()" class="hidden md:inline-flex bg-white border border-slate-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
            + Service Call
          </button>
          <button @click="startNewQuote()" class="hidden md:inline-flex bg-primary text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
            + Quote
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-auto p-4 md:p-8 bg-surface">

        <!-- DASHBOARD (kept; small enhancement only: schedule shows time) -->
        <div v-if="view === 'dashboard'" class="space-y-6 max-w-7xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <p class="text-xs font-bold text-slate-400 uppercase">Revenue</p>
              <h3 class="text-2xl font-bold text-slate-800 mt-2">${{ dashboard.revenue.toLocaleString() }}</h3>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <p class="text-xs font-bold text-slate-400 uppercase">Active Jobs</p>
              <h3 class="text-2xl font-bold text-slate-800 mt-2">{{ dashboard.active_jobs }}</h3>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <p class="text-xs font-bold text-slate-400 uppercase">Pending Quotes</p>
              <h3 class="text-2xl font-bold text-slate-800 mt-2">{{ dashboard.pending }}</h3>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <p class="text-xs font-bold text-slate-400 uppercase">Avg Ticket</p>
              <h3 class="text-2xl font-bold text-slate-800 mt-2">${{ dashboard.avg_ticket.toFixed(0) }}</h3>
            </div>
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Recent Activity</div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600 whitespace-nowrap">
                  <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                    <tr><th class="px-6 py-3">Customer</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-right">Amount</th></tr>
                  </thead>
                  <tbody>
                    <tr v-for="item in dashboard.recent" :key="item.id" class="border-b border-slate-50">
                      <td class="px-6 py-4 font-bold">{{ item.customer_name }}</td>
                      <td class="px-6 py-4"><span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ item.status }}</span></td>
                      <td class="px-6 py-4 font-bold text-right">${{ item.total.toFixed(0) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Today's Schedule</div>
              <div class="p-4 space-y-3 h-64 overflow-y-auto">
                <div v-if="!dashboard.schedule.length" class="text-center text-slate-400 text-sm py-8">No jobs today.</div>
                <div v-for="job in dashboard.schedule" class="border border-slate-100 rounded-lg p-3 bg-slate-50">
                  <div class="flex justify-between font-bold text-sm">
                    <span>{{ job.customer_name }}</span><span class="text-slate-500">{{ job.scheduled_date }}</span>
                  </div>
                  <div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-user-gear mr-1"></i> {{ job.tech || 'Unassigned' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DISPATCH (kept; enhanced to support true scheduling with time + duration, and create service calls) -->
        <div v-if="view === 'dispatch'" class="max-w-7xl mx-auto h-[calc(100vh-8rem)] flex flex-col md:flex-row gap-6">
          <div class="w-full md:w-1/3 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
            <div class="p-4 border-b border-slate-100 bg-red-50 rounded-t-xl flex items-center justify-between gap-2">
              <h3 class="font-bold text-red-700">Unscheduled Jobs ({{ dispatchData.unscheduled.length }})</h3>
              <button @click="openServiceCallModal()" class="bg-white border border-slate-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-50">
                + New
              </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
              <div v-if="!dispatchData.unscheduled.length" class="text-center text-slate-400 py-10 text-sm">All jobs scheduled!</div>
              <div v-for="job in dispatchData.unscheduled" :key="job.id" class="border border-slate-200 rounded-lg p-4 bg-white shadow-sm">
                <div class="flex justify-between items-start mb-2">
                  <span class="font-bold text-slate-800">{{ job.customer_name }}</span>
                  <span class="bg-amber-100 text-amber-800 text-xs px-2 py-0.5 rounded-full font-bold">{{ job.status || 'Unscheduled' }}</span>
                </div>
                <div class="text-xs text-slate-500 mb-3"><i class="fa-solid fa-location-dot mr-1"></i> {{ job.address }}</div>
                <div class="flex justify-between items-center">
                  <span class="font-bold text-slate-700">${{ job.total.toFixed(0) }}</span>
                  <div class="flex items-center gap-2">
                    <button @click="openJobDetails(job)" class="bg-white border px-3 py-1.5 rounded text-xs font-bold">Details</button>
                    <button @click="openAssignModal(job)" class="bg-primary text-white px-3 py-1.5 rounded text-xs font-bold">Schedule</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="w-full md:w-2/3 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
            <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex items-center justify-between">
              <h3 class="font-bold text-slate-700">Technician Schedule</h3>
              <button @click="refreshDispatch()" class="text-xs font-bold text-slate-500 hover:text-primary">Refresh</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div v-for="tech in dispatchData.techs" :key="tech.username" class="border border-slate-200 rounded-lg bg-slate-50">
                  <div class="p-3 border-b border-slate-200 flex items-center gap-2 bg-white rounded-t-lg">
                    <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">{{ tech.full_name.charAt(0) }}</div>
                    <span class="font-bold text-sm text-slate-700">{{ tech.full_name }}</span>
                  </div>
                  <div class="p-3 space-y-2 min-h-[100px]">
                    <div v-for="job in getTechJobs(tech.username)" :key="job.id" class="bg-white border border-slate-200 p-2 rounded text-sm shadow-sm hover:border-primary cursor-pointer"
                         @click="openJobDetails(job)">
                      <div class="font-semibold">{{ job.customer_name }}</div>
                      <div class="text-xs text-slate-500 flex justify-between mt-1">
                        <span>{{ job.scheduled_date }} {{ job.scheduled_time }}</span>
                        <span class="font-bold">${{ job.total.toFixed(0) }}</span>
                      </div>
                      <div class="text-[11px] text-slate-400 mt-1">{{ job.status }}</div>
                    </div>
                    <div v-if="getTechJobs(tech.username).length===0" class="text-xs text-slate-400">No scheduled jobs.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- NEW: SERVICE CALLS LIST (admin management view) -->
        <div v-if="view === 'service-calls'" class="max-w-7xl mx-auto space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-slate-800">Service Calls</h2>
              <p class="text-sm text-slate-500">Create, schedule, and complete service calls.</p>
            </div>
            <button @click="openServiceCallModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
              + New Service Call
            </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-sm text-left text-slate-600">
              <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                <tr>
                  <th class="px-6 py-3">Customer</th>
                  <th class="px-6 py-3">Status</th>
                  <th class="px-6 py-3">Scheduled</th>
                  <th class="px-6 py-3">Tech</th>
                  <th class="px-6 py-3 text-right">Total</th>
                  <th class="px-6 py-3 text-right">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="job in allServiceCalls" :key="job.id" class="border-b border-slate-50">
                  <td class="px-6 py-4 font-bold">
                    {{ job.customer_name }}
                    <div class="text-xs text-slate-400 font-normal">{{ job.address }}</div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ job.status }}</span>
                  </td>
                  <td class="px-6 py-4">{{ job.scheduled_date ? (job.scheduled_date + ' ' + job.scheduled_time) : '—' }}</td>
                  <td class="px-6 py-4">{{ job.tech || '—' }}</td>
                  <td class="px-6 py-4 text-right font-bold">${{ job.total.toFixed(0) }}</td>
                  <td class="px-6 py-4 text-right">
                    <button @click="openJobDetails(job)" class="text-primary text-xs font-bold hover:underline">Open</button>
                    <span class="mx-2 text-slate-200">|</span>
                    <button v-if="!job.scheduled_date" @click="openAssignModal(job)" class="text-xs font-bold text-slate-700 hover:underline">Schedule</button>
                  </td>
                </tr>
                <tr v-if="!allServiceCalls.length">
                  <td colspan="6" class="px-6 py-10 text-center text-slate-400">No service calls yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        
        <!-- NEW: WORK ORDERS (by job) -->
        <div v-if="view === 'workorders'" class="max-w-7xl mx-auto space-y-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-xl font-bold text-slate-800">Work Orders</h2>
              <p class="text-sm text-slate-500">Browse jobs, open work orders, and create return visits.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <select v-model="workordersFilter" @change="refreshWorkorders()" class="border rounded-lg p-2 text-sm font-bold">
                <option value="">All Statuses</option>
                <option value="New">New</option>
                <option value="Approved">Approved</option>
                <option value="Scheduled">Scheduled</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
              <button @click="refreshWorkorders()" class="bg-white border border-slate-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
                Refresh
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-600">
                <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                  <tr>
                    <th class="px-4 md:px-6 py-3">Job</th>
                    <th class="px-4 md:px-6 py-3">Customer</th>
                    <th class="px-4 md:px-6 py-3">Status</th>
                    <th class="px-4 md:px-6 py-3">Scheduled</th>
                    <th class="px-4 md:px-6 py-3">Tech</th>
                    <th class="px-4 md:px-6 py-3 text-right">Total</th>
                    <th class="px-4 md:px-6 py-3 text-right">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="j in workorders" :key="j.id" class="border-b border-slate-50">
                    <td class="px-4 md:px-6 py-4 font-bold">
                      {{ j.id }}
                      <div v-if="j.parent_id" class="text-xs text-slate-400 font-normal">Return visit for {{ j.parent_id }}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4 font-bold">
                      {{ j.customer_name }}
                      <div class="text-xs text-slate-400 font-normal truncate max-w-[18rem]">{{ j.address }}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                      <span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ j.status }}</span>
                    </td>
                    <td class="px-4 md:px-6 py-4">{{ j.scheduled_date ? (j.scheduled_date + ' ' + j.scheduled_time) : '—' }}</td>
                    <td class="px-4 md:px-6 py-4">{{ j.tech || '—' }}</td>
                    <td class="px-4 md:px-6 py-4 text-right font-bold">${{ (j.total||0).toFixed(0) }}</td>
                    <td class="px-4 md:px-6 py-4 text-right whitespace-nowrap">
                      <button @click="openJobDetails(j)" class="text-primary text-xs font-bold hover:underline">Open</button>
                      <template v-if="user.role==='admin' && !j.scheduled_date && (j.status==='New' || j.status==='Approved')">
                        <span class="mx-2 text-slate-200">|</span>
                        <button @click="openAssignModal(j)" class="text-xs font-bold text-slate-700 hover:underline">Schedule</button>
                      </template>
                    </td>
                  </tr>
                  <tr v-if="!workorders.length">
                    <td colspan="7" class="px-6 py-10 text-center text-slate-400">No work orders.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>


<!-- TECH: MY SCHEDULE (kept) -->
        <div v-if="view === 'my-schedule'" class="max-w-2xl mx-auto space-y-4">
          <div v-for="job in myJobs" :key="job.id" class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-bold text-lg text-slate-800">{{ job.customer_name }}</h3>
                <div class="text-sm text-slate-500">{{ job.address }}</div>
              </div>
              <div class="text-right">
                <div class="text-xs font-bold bg-blue-50 text-blue-700 px-2 py-1 rounded-full mb-1">{{ job.status }}</div>
                <div class="text-sm font-bold text-slate-700">{{ job.scheduled_date }} {{ job.scheduled_time }}</div>
              </div>
            </div>
            <div class="border-t border-slate-100 pt-4 flex gap-2">
              <button @click="openJobDetails(job)" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
                View & Start Job
              </button>
            </div>
          </div>
          <div v-if="myJobs.length === 0" class="text-center py-12 text-slate-400">
            <div class="text-4xl mb-2"><i class="fa-solid fa-mug-hot"></i></div>
            <p>No jobs assigned to you.</p>
          </div>
        </div>

        <!-- JOB DETAILS (kept; improved item qty controls, separate selector variable) -->
        <div v-if="view === 'job-details'" class="max-w-3xl mx-auto">
          <button @click="goBackFromDetails()" class="mb-4 text-slate-500 hover:text-primary font-bold text-sm">
            <i class="fa-solid fa-arrow-left"></i> Back
          </button>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="border-b border-slate-100 pb-4 mb-4">
              <h2 class="text-xl font-bold text-slate-800">{{ activeJob.customer_name }}</h2>
              <p class="text-sm text-slate-500">{{ activeJob.address }}</p>
              <p class="text-xs text-slate-400 mt-1" v-if="activeJob.scheduled_date">Scheduled: {{ activeJob.scheduled_date }} {{ activeJob.scheduled_time }} • {{ activeJob.tech || 'Unassigned' }}</p>
            </div>

            <div class="mb-6">
              <h4 class="font-bold text-sm text-slate-400 uppercase mb-3">Work Order Items</h4>

              <div v-for="(item, idx) in activeJobItems" :key="idx" class="flex justify-between items-center bg-slate-50 p-3 rounded mb-2 border border-slate-100">
                <div class="min-w-0">
                  <div class="font-bold text-sm truncate">{{ item.name }}</div>
                  <div class="text-xs text-slate-500">${{ Number(item.price).toFixed(2) }}</div>
                  <input v-model="item.note" placeholder="Line Note (optional)" class="mt-1 w-full border border-slate-200 rounded px-2 py-1 text-xs bg-white" />
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex items-center border rounded-lg overflow-hidden bg-white">
                    <button @click="decQty(activeJobItems, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-minus"></i></button>
                    <div class="px-3 py-1 text-sm font-bold w-10 text-center">{{ item.qty || 1 }}</div>
                    <button @click="incQty(activeJobItems, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-plus"></i></button>
                  </div>
                  <button @click="activeJobItems.splice(idx, 1)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                </div>
              </div>

              <div class="flex gap-2 mt-4">
                <select v-model="jobSelectedPart" class="flex-1 border p-2 rounded text-sm">
                  <option value="" disabled>Add Part/Labor...</option>
                  <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                </select>
                <button @click="addJobItem" class="bg-secondary text-white px-4 rounded text-sm font-bold">Add</button>
              </div>
            </div>

            <div class="mb-6">
              <h4 class="font-bold text-sm text-slate-400 uppercase mb-2">Completion Notes</h4>
              <textarea v-model="activeJobNotes" class="w-full border rounded p-3 text-sm h-24" placeholder="Describe work done..."></textarea>
            </div>

            <div class="flex justify-between items-center border-t border-slate-100 pt-6">
              <div class="text-right">
                <div class="text-sm text-slate-500">Total Invoice</div>
                <div class="text-2xl font-bold text-slate-800">${{ activeJobTotal.toFixed(2) }}</div>
              </div>
              <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-end">
                <button @click="saveJobProgress" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
                  Save Progress
                </button>
                <button @click="openFollowupModal" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
                  + Create Return Visit
                </button>
                <button @click="openSignatureModal" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-green-500/30">
                  Complete Job
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- QUOTES LIST (kept; enhanced with open/edit/status actions) -->
        <div v-if="view === 'quotes'" class="max-w-7xl mx-auto space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-slate-800">Quotes</h2>
              <p class="text-sm text-slate-500">Create, edit, approve, and convert to scheduled work.</p>
            </div>
            <button @click="startNewQuote()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
              + New Quote
            </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-sm text-left text-slate-600">
              <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                <tr>
                  <th class="px-6 py-3">Customer</th>
                  <th class="px-6 py-3">Total</th>
                  <th class="px-6 py-3">Status</th>
                  <th class="px-6 py-3 text-right">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="q in quotesList" :key="q.id" class="border-b border-slate-50">
                  <td class="px-6 py-4 font-bold">{{ q.customer_name }}</td>
                  <td class="px-6 py-4">${{ q.total.toFixed(2) }}</td>
                  <td class="px-6 py-4">
                    <span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ q.status }}</span>
                  </td>
                  <td class="px-6 py-4 text-right whitespace-nowrap">
                    <button @click="openQuote(q.id)" class="text-primary text-xs font-bold hover:underline">Open</button>
                    <span class="mx-2 text-slate-200">|</span>
                    <button @click="quickSetQuoteStatus(q.id,'Sent')" class="text-xs font-bold text-slate-700 hover:underline">Send</button>
                    <span class="mx-2 text-slate-200">|</span>
                    <button @click="quickSetQuoteStatus(q.id,'Approved')" class="text-xs font-bold text-green-700 hover:underline">Approve</button>
                    <span class="mx-2 text-slate-200">|</span>
                    <button @click="quickSetQuoteStatus(q.id,'Declined')" class="text-xs font-bold text-red-600 hover:underline">Decline</button>
                  </td>
                </tr>
                <tr v-if="!quotesList.length">
                  <td colspan="4" class="px-6 py-10 text-center text-slate-400">No quotes yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- NEW: QUOTE DETAILS (manage quote) -->
        <div v-if="view === 'quote-details'" class="max-w-4xl mx-auto space-y-4">
          <button @click="setView('quotes')" class="text-slate-500 hover:text-primary font-bold text-sm">
            <i class="fa-solid fa-arrow-left"></i> Back to Quotes
          </button>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-start justify-between gap-4 border-b border-slate-100 pb-4 mb-4">
              <div>
                <h2 class="text-xl font-bold text-slate-800">Quote {{ activeQuote.id }}</h2>
                <p class="text-sm text-slate-500">{{ activeQuote.customer_name }}</p>
              </div>
              <div class="flex items-center gap-2">
                <select v-model="activeQuote.status" class="border rounded-lg p-2 text-sm font-bold">
                  <option>Draft</option>
                  <option>Sent</option>
                  <option>Approved</option>
                  <option>Declined</option>
                </select>
                <button @click="saveActiveQuote()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
                  Save
                </button>
              </div>
            </div>

            <div class="mb-6">
              <h4 class="font-bold text-sm text-slate-400 uppercase mb-3">Line Items</h4>

              <div v-for="(item, idx) in activeQuote.items" :key="idx" class="flex justify-between items-center bg-slate-50 p-3 rounded mb-2 border border-slate-100">
                <div class="min-w-0">
                  <div class="font-bold text-sm truncate">{{ item.name }}</div>
                  <div class="text-xs text-slate-500">${{ Number(item.price).toFixed(2) }}</div>
                  <input v-model="item.note" placeholder="Line Note (optional)" class="mt-1 w-full border border-slate-200 rounded px-2 py-1 text-xs bg-white" />
                </div>

                <div class="flex items-center gap-3">
                  <div class="flex items-center border rounded-lg overflow-hidden bg-white">
                    <button @click="decQty(activeQuote.items, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-minus"></i></button>
                    <div class="px-3 py-1 text-sm font-bold w-10 text-center">{{ item.qty || 1 }}</div>
                    <button @click="incQty(activeQuote.items, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-plus"></i></button>
                  </div>
                  <button @click="activeQuote.items.splice(idx,1)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                </div>
              </div>

              <div class="flex flex-col md:flex-row gap-2 mt-4">
                <select v-model="quoteSelectedPart" class="flex-1 border p-2 rounded text-sm">
                  <option value="" disabled>Add Item...</option>
                  <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                </select>
                <select v-model="quoteSelectedLabor" class="flex-1 border p-2 rounded text-sm">
                  <option value="" disabled>Add Labor...</option>
                  <option v-for="p in laborCatalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                </select>
                <button @click="addQuoteItemToActive()" class="bg-secondary text-white px-4 rounded text-sm font-bold">Add</button>
              </div>
            </div>

            <div class="mb-6">
              <h4 class="font-bold text-sm text-slate-400 uppercase mb-2">Notes</h4>
              <textarea v-model="activeQuote.notes" class="w-full border rounded p-3 text-sm h-24" placeholder="Notes to customer..."></textarea>
            </div>

            <div class="flex justify-between items-center border-t border-slate-100 pt-6">
              <div>
                <div class="text-sm text-slate-500">Quote Total</div>
                <div class="text-2xl font-bold text-slate-800">${{ quoteTotal(activeQuote.items).toFixed(2) }}</div>
              </div>
              <div class="flex items-center gap-2">
                <button @click="quickSetQuoteStatus(activeQuote.id, 'Sent', true)" class="bg-white border px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
                  Mark Sent
                </button>
                <button @click="quickSetQuoteStatus(activeQuote.id, 'Approved', true)" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-600">
                  Approve & Create Job
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS (kept; enhanced to open account details and show quotes associated) -->
        <div v-if="view === 'accounts'" class="max-w-6xl mx-auto space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-800">Customers</h2>
            <button @click="openClientModal()" class="bg-white border px-4 py-2 rounded shadow-sm text-sm font-bold">+ Add Account</button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-sm text-left text-slate-600">
              <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                <tr><th class="px-6 py-3">Name</th><th class="px-6 py-3 text-right">Action</th></tr>
              </thead>
              <tbody>
                <tr v-for="c in customers" :key="c.id" class="border-b border-slate-50">
                  <td class="px-6 py-4 font-bold">
                    {{ c.name }}
                    <div class="text-xs text-slate-400 font-normal">{{ c.email }}</div>
                  </td>
                  <td class="px-6 py-4 text-right whitespace-nowrap">
                    <button @click="openAccount(c.id)" class="text-primary text-xs font-bold hover:underline">View</button>
                    <span class="mx-2 text-slate-200">|</span>
                    <button @click="openClientModal(c)" class="text-primary text-xs font-bold hover:underline">Edit</button>
                  </td>
                </tr>
                <tr v-if="!customers.length">
                  <td colspan="2" class="px-6 py-10 text-center text-slate-400">No customers yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- NEW: ACCOUNT DETAILS (shows quotes associated to account + service calls) -->
        <div v-if="view === 'account-details'" class="max-w-6xl mx-auto space-y-6">
          <button @click="setView('accounts')" class="text-slate-500 hover:text-primary font-bold text-sm">
            <i class="fa-solid fa-arrow-left"></i> Back to Customers
          </button>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-bold text-slate-800">{{ accountSummary.customer.name }}</h2>
                <div class="text-sm text-slate-500 mt-1">{{ accountSummary.customer.address }} • {{ accountSummary.customer.city }}</div>
                <div class="text-sm text-slate-500">{{ accountSummary.customer.phone }} • {{ accountSummary.customer.email }}</div>
              </div>
              <div class="flex items-center gap-2">
                <button @click="startNewQuote(accountSummary.customer.id)" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
                  + Quote
                </button>
                <button @click="openServiceCallModal(accountSummary.customer.id)" class="bg-white border px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-50">
                  + Service Call
                </button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Quotes</div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                  <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                    <tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-right">Total</th><th class="px-6 py-3 text-right">Action</th></tr>
                  </thead>
                  <tbody>
                    <tr v-for="q in accountSummary.quotes" :key="q.id" class="border-b border-slate-50">
                      <td class="px-6 py-4 font-bold">{{ q.id }}</td>
                      <td class="px-6 py-4"><span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ q.status }}</span></td>
                      <td class="px-6 py-4 text-right font-bold">${{ q.total.toFixed(0) }}</td>
                      <td class="px-6 py-4 text-right">
                        <button @click="openQuote(q.id)" class="text-primary text-xs font-bold hover:underline">Open</button>
                      </td>
                    </tr>
                    <tr v-if="!accountSummary.quotes.length">
                      <td colspan="4" class="px-6 py-10 text-center text-slate-400">No quotes for this customer.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Service Calls</div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                  <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                    <tr><th class="px-6 py-3">Status</th><th class="px-6 py-3">Scheduled</th><th class="px-6 py-3">Tech</th><th class="px-6 py-3 text-right">Action</th></tr>
                  </thead>
                  <tbody>
                    <tr v-for="j in accountSummary.service_calls" :key="j.id" class="border-b border-slate-50">
                      <td class="px-6 py-4"><span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ j.status }}</span></td>
                      <td class="px-6 py-4">{{ j.scheduled_date ? (j.scheduled_date + ' ' + j.scheduled_time) : '—' }}</td>
                      <td class="px-6 py-4">{{ j.tech || '—' }}</td>
                      <td class="px-6 py-4 text-right">
                        <button @click="openJobDetails(j)" class="text-primary text-xs font-bold hover:underline">Open</button>
                        <span v-if="!j.scheduled_date" class="mx-2 text-slate-200">|</span>
                        <button v-if="!j.scheduled_date" @click="openAssignModal(j)" class="text-xs font-bold text-slate-700 hover:underline">Schedule</button>
                      </td>
                    </tr>
                    <tr v-if="!accountSummary.service_calls.length">
                      <td colspan="4" class="px-6 py-10 text-center text-slate-400">No service calls yet.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- BUILDER (kept; improved cart editing) -->
        <div v-if="view === 'builder'" class="max-w-4xl mx-auto">
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-bold mb-4">New Quote</h3>

            <div class="grid gap-4 mb-4">
              <select v-model="selectedCustomer" class="w-full border p-2 rounded text-sm">
                <option value="" disabled>Select Customer...</option>
                <option v-for="c in customers" :key="c.id" :value="c.id">{{ c.name }}</option>
              </select>

              <div class="flex flex-col md:flex-row gap-2">
                <select v-model="selectedPart" class="flex-1 border p-2 rounded text-sm">
                  <option value="" disabled>Select Item...</option>
                  <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                </select>
                <select v-model="selectedLabor" class="flex-1 border p-2 rounded text-sm">
                  <option value="" disabled>Add Labor...</option>
                  <option v-for="p in laborCatalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                </select>
                <button @click="addItem" class="bg-secondary text-white px-4 rounded text-sm font-bold">Add</button>
              </div>
            </div>

            <div v-if="cart.length > 0" class="mb-4 bg-slate-50 p-4 rounded">
              <div v-for="(item, idx) in cart" :key="idx" class="flex justify-between items-center text-sm mb-2">
                <div class="min-w-0">
                  <div class="font-bold truncate">{{ item.name }}</div>
                  <div class="text-xs text-slate-500">${{ Number(item.price).toFixed(2) }}</div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex items-center border rounded-lg overflow-hidden bg-white">
                    <button @click="decQty(cart, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-minus"></i></button>
                    <div class="px-3 py-1 text-sm font-bold w-10 text-center">{{ item.qty || 1 }}</div>
                    <button @click="incQty(cart, idx)" class="px-2 py-1 text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-plus"></i></button>
                  </div>
                  <button @click="cart.splice(idx,1)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                </div>
              </div>
              <div class="border-t pt-2 mt-2 flex justify-between font-bold">
                <span>Total</span>
                <span>${{ total.toFixed(2) }}</span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <button @click="saveQuote('Draft')" class="w-full bg-white border border-slate-200 text-slate-800 py-3 rounded font-bold hover:bg-slate-50">
                Save Draft
              </button>
              <button @click="saveQuote('Sent')" class="w-full bg-primary text-white py-3 rounded font-bold hover:bg-blue-600">
                Save & Mark Sent
              </button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- ASSIGN MODAL (kept; adds time + duration; DOES NOT remove existing fields) -->
  <div v-if="showAssignModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold mb-4">Schedule Job</h3>

      <div class="mb-4">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Technician</label>
        <select v-model="assignForm.tech" class="w-full border rounded p-2 text-sm">
          <option value="" disabled>Select Tech...</option>
          <option v-for="t in dispatchData.techs" :key="t.username" :value="t.username">{{ t.full_name }}</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
          <input type="date" v-model="assignForm.date" class="w-full border rounded p-2 text-sm">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start</label>
          <input type="time" v-model="assignForm.time" class="w-full border rounded p-2 text-sm">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duration (minutes)</label>
        <input type="number" v-model.number="assignForm.duration" min="15" step="15" class="w-full border rounded p-2 text-sm">
      </div>

      <div class="flex justify-end gap-2">
        <button @click="showAssignModal=false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button>
        <button @click="confirmAssign" class="px-4 py-2 bg-primary text-white rounded text-sm">Assign</button>
      </div>
    </div>
  </div>

  <!-- CUSTOMER MODAL (kept) -->
  <div v-if="showModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold mb-4">{{ isEditing ? 'Edit' : 'New' }} Customer</h3>
      <input v-model="formClient.name" placeholder="Name" class="w-full border rounded p-2 mb-2 text-sm">
      <input v-model="formClient.email" placeholder="Email" class="w-full border rounded p-2 mb-2 text-sm">
      <input v-model="formClient.phone" placeholder="Phone" class="w-full border rounded p-2 mb-2 text-sm">
      <input v-model="formClient.address" placeholder="Address" class="w-full border rounded p-2 mb-2 text-sm">
      <input v-model="formClient.city" placeholder="City" class="w-full border rounded p-2 mb-4 text-sm">

      <div class="flex justify-end gap-2">
        <button @click="showModal=false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button>
        <button @click="saveClient" class="px-4 py-2 bg-primary text-white rounded text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- NEW: SERVICE CALL CREATION MODAL -->
  <div v-if="showServiceCallModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
      <h3 class="text-lg font-bold mb-4">New Service Call</h3>

      <div class="grid gap-3 mb-4">
        <label class="text-xs font-bold text-slate-500 uppercase">Customer</label>
        <select v-model="serviceCallForm.customer_id" class="w-full border rounded p-2 text-sm">
          <option value="" disabled>Select Customer...</option>
          <option v-for="c in customers" :key="c.id" :value="c.id">{{ c.name }}</option>
        </select>

        <label class="text-xs font-bold text-slate-500 uppercase">Title</label>
        <input v-model="serviceCallForm.title" class="w-full border rounded p-2 text-sm" placeholder="Service Call Title">

        <label class="text-xs font-bold text-slate-500 uppercase">Address</label>
        <input v-model="serviceCallForm.address" class="w-full border rounded p-2 text-sm" placeholder="Address (optional; defaults to customer address)">

        <label class="text-xs font-bold text-slate-500 uppercase">Notes</label>
        <textarea v-model="serviceCallForm.notes" class="w-full border rounded p-2 text-sm h-20" placeholder="Internal notes..."></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="showServiceCallModal=false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button>
        <button @click="createServiceCall" class="px-4 py-2 bg-primary text-white rounded text-sm">Create</button>
      </div>
    </div>
  </div>

  <!-- FOLLOW-UP WORK ORDER MODAL -->
  <div v-if="showFollowupModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
      <h3 class="text-lg font-bold mb-2">Create Return Visit</h3>
      <p class="text-sm text-slate-500 mb-4">Create a new work order for this customer if you need to come back.</p>

      <div class="mb-3">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reason / Notes</label>
        <textarea v-model="followupForm.notes" class="w-full border rounded p-2 text-sm h-24" placeholder="What needs to be done on the return visit?"></textarea>
      </div>

      <div class="mb-4 flex items-center gap-2">
        <input id="copyItems" type="checkbox" v-model="followupForm.copy_items" class="w-4 h-4">
        <label for="copyItems" class="text-sm text-slate-600">Copy current line items to the new work order</label>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="showFollowupModal=false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button>
        <button @click="createFollowupWorkorder" class="px-4 py-2 bg-primary text-white rounded text-sm">Create</button>
      </div>
    </div>
  </div>

  <!-- SIGNATURE MODAL -->
  <div v-if="showSignatureModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
      <h3 class="text-lg font-bold mb-2">Customer Sign-Off</h3>
      <p class="text-sm text-slate-500 mb-4">Have the customer sign before completing the work order.</p>

      <div class="mb-3">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Name</label>
        <input v-model="signatureForm.signer_name" class="w-full border rounded p-2 text-sm" placeholder="Customer name">
      </div>

      <div class="mb-3">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Signature</label>
        <div class="border rounded-lg overflow-hidden bg-white">
          <canvas id="sigCanvas" class="w-full h-40 bg-white touch-none"></canvas>
        </div>
        <div class="flex gap-2 mt-2">
          <button @click="clearSignature" class="bg-white border px-3 py-2 rounded text-xs font-bold">Clear</button>
          <button @click="skipSignature" class="bg-white border px-3 py-2 rounded text-xs font-bold">Skip</button>
        </div>
        <p class="text-xs text-slate-400 mt-2">Tip: Use your finger on mobile/tablet.</p>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="showSignatureModal=false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button>
        <button @click="completeJobWithSignature" class="px-4 py-2 bg-green-600 text-white rounded text-sm font-bold">Complete</button>
      </div>
    </div>
  </div>

</div>

<script>
const { createApp } = Vue

createApp({
  data() {
    return {
      user: null,
      notifications: [],
      loginForm: { username: '', password: '' },
      view: 'dashboard',
      mobileMenu: false,

      dashboard: { revenue: 0, pending: 0, active_jobs: 0, avg_ticket: 0, recent: [], schedule: [] },
      dispatchData: { unscheduled: [], techs: [], scheduled: [] },

      myJobs: [],

      quotesList: [],
      customers: [],
      catalog: [],

      // Quote Builder (existing)
      cart: [],
      selectedCustomer: "",
      selectedPart: "",

      // NEW: Quote Details state
      activeQuote: { id: "", customer_id: "", customer_name: "", status: "Draft", notes: "", items: [] },
      quoteSelectedPart: "",

      // Active Job Logic (existing)
      activeJob: null,
      activeJobItems: [],
      activeJobNotes: "",
      jobSelectedPart: "",

      // Customers modal (existing)
      showModal: false,
      isEditing: false,
      formClient: { id: null, name: "", email: "", phone: "", address: "", city: "" },

      // Assign modal (existing + enhanced)
      showAssignModal: false,
      assignForm: { quote_id: null, tech: "", date: "", time: "09:00", duration: 120 },

      // NEW: Account Details
      accountSummary: { customer: {id:"",name:"",email:"",phone:"",address:"",city:""}, quotes: [], service_calls: [] },
      lastListView: "my-schedule",

      // NEW: Service Call modal
      showServiceCallModal: false,
      serviceCallForm: { customer_id: "", title: "Service Call", address: "", notes: "" },

      // Cache for full service calls list
      allServiceCalls: [],

      // Work Orders (by job)
      workorders: [],
      workordersFilter: "",

      // Labor dropdown
      selectedLabor: "",
      quoteSelectedLabor: "",

      // Follow-up work order
      showFollowupModal: false,
      followupForm: { notes: "", copy_items: true },

      // Customer signature
      showSignatureModal: false,
      signatureForm: { signer_name: "", signature_b64: "" }

    }
  },
  computed: {
    laborCatalog() { return (this.catalog || []).filter(i => (i.item_type || 'Part') === 'Labor') },
    total() { return this.cart.reduce((s, i) => s + (Number(i.price) * (Number(i.qty)||1)), 0) },
    activeJobTotal() { return this.activeJobItems.reduce((s, i) => s + (Number(i.price) * (Number(i.qty)||1)), 0) }
  },
  methods: {
    notify(title, message, type='info', ttl=3500) {
      const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`
      this.notifications.push({ id, title, message, type })
      setTimeout(() => this.dismissToast(id), ttl)
    },
    dismissToast(id) {
      this.notifications = (this.notifications || []).filter(n => n.id !== id)
    },

    quoteTotal(items) { return (items||[]).reduce((s,i)=> s + (Number(i.price) * (Number(i.qty)||1)), 0) },

    incQty(arr, idx) { arr[idx].qty = (Number(arr[idx].qty)||1) + 1 },
    decQty(arr, idx) { arr[idx].qty = Math.max(1, (Number(arr[idx].qty)||1) - 1) },

    async login() {
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(this.loginForm)
        })
        if(!res.ok) throw new Error()
        const data = await res.json()
        this.user = data.user
        await this.initData()
        await this.refreshDashboard()
      } catch(e) {
        this.notify("Login failed", "Check username/password.", "error")
      }
    },
    logout() {
      this.user = null
      this.loginForm = { username:'', password:'' }
      this.view = 'dashboard'
    },
    navClass(v) { return this.view === v ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50' },

    async setView(v) {
      this.view = v
      this.mobileMenu = false

      if(v === 'dashboard') await this.refreshDashboard()
      if(v === 'quotes') await this.refreshQuotes()
      if(v === 'dispatch') await this.refreshDispatch()
      if(v === 'my-schedule') await this.refreshMyJobs()
      if(v === 'service-calls') await this.refreshServiceCalls()
      if(v === 'workorders') await this.refreshWorkorders()
    },

    async initData() {
      const res = await fetch('/api/init-data')
      const data = await res.json()
      this.customers = data.customers || []
      this.catalog = (data.catalog || []).map(i => ({ ...i, item_type: i.item_type || 'Part' }))
    },

    async refreshDashboard() {
      const res = await fetch('/api/dashboard')
      this.dashboard = await res.json()
    },

    async refreshQuotes() {
      const res = await fetch('/api/quotes')
      this.quotesList = await res.json()
    },

    async refreshDispatch() {
      const res = await fetch('/api/dispatch-data')
      this.dispatchData = await res.json()
      // Keep service calls list in sync
      this.allServiceCalls = [...(this.dispatchData.unscheduled||[]), ...(this.dispatchData.scheduled||[])]
    },

    async refreshWorkorders() {
      const role = this.user?.role || 'admin'
      const username = this.user?.username || ''
      const status = this.workordersFilter || ''
      const qs = new URLSearchParams({ role, username })
      if(status) qs.set('status', status)
      const res = await fetch(`/api/workorders?${qs.toString()}`)
      this.workorders = await res.json()
    },

    async refreshServiceCalls() {
      await this.refreshDispatch()
      // Flatten into one list and sort
      const all = [...(this.dispatchData.unscheduled||[]), ...(this.dispatchData.scheduled||[])]
      all.sort((a,b)=> (a.scheduled_date||"9999") > (b.scheduled_date||"9999") ? 1 : -1)
      this.allServiceCalls = all
    },

    async refreshMyJobs() {
      const res = await fetch(`/api/my-jobs?username=${encodeURIComponent(this.user.username)}`)
      this.myJobs = await res.json()
    },

    getTechJobs(username) {
      return (this.dispatchData.scheduled || []).filter(j => j.tech === username)
    },

    // -------------------- Jobs / Work Orders --------------------
    openJobDetails(job) {
      this.lastListView = (this.user.role === 'tech') ? 'my-schedule' : (this.view || 'dispatch')
      this.activeJob = job
      try {
        const raw = JSON.parse(job.items_json || "[]") || []
        this.activeJobItems = raw.map(x => ({ ...x, qty: Number(x.qty||1), item_type: x.item_type || "Part", note: x.note || "" }))
      } catch(e) { this.activeJobItems = [] }
      this.activeJobNotes = job.notes || ""
      this.jobSelectedPart = ""
      this.view = 'job-details'
    },
    goBackFromDetails() {
      // Return to where user came from
      if (this.user.role === 'tech') return this.setView('my-schedule')
      return this.setView(this.lastListView || 'dispatch')
    },
    addJobItem() {
      if(!this.jobSelectedPart) return
      const item = this.jobSelectedPart
      const item_type = item.item_type || (item.category === 'Labor' ? 'Labor' : 'Part')
      this.activeJobItems.push({ ...item, item_type, note: '', qty: 1 })
      this.jobSelectedPart = ''
    },
    
    saveJobProgress() {
      if(!this.activeJob?.id) return
      // Save current line items + notes (does not complete job)
      this.persistJobUpdate("In Progress")
    },
    async persistJobUpdate(status="") {
      const payload = {
        job_id: this.activeJob.id,
        items: this.activeJobItems,
        notes: this.activeJobNotes || "",
        status
      }
      const res = await fetch("/api/jobs/update", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      })
      if(res.ok) {
        this.notify("Saved", "Work order progress saved.", "success")
        await this.refreshWorkorders().catch(()=>{})
        await this.refreshMyJobs().catch(()=>{})
      } else {
        this.notify("Save failed", "Could not save work order.", "error")
      }
    },

    openFollowupModal() {
      this.followupForm = { notes: "", copy_items: true }
      this.showFollowupModal = true
    },
    async createFollowupWorkorder() {
      if(!this.activeJob?.id) return
      const res = await fetch("/api/jobs/followup", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          job_id: this.activeJob.id,
          copy_items: !!this.followupForm.copy_items,
          notes: this.followupForm.notes || ""
        })
      })
      if(res.ok) {
        const data = await res.json()
        this.showFollowupModal = false
        this.notify("Return visit created", `New work order ${data.id} created.`, "success")
        await this.refreshWorkorders().catch(()=>{})
        await this.refreshDispatch().catch(()=>{})
      } else {
        this.notify("Create failed", "Could not create return visit.", "error")
      }
    },

    openSignatureModal() {
      this.showSignatureModal = true
      this.signatureForm = { signer_name: "", signature_b64: "" }
      this.$nextTick(() => this.initSignaturePad())
    },
    initSignaturePad() {
      const canvas = document.getElementById("sigCanvas")
      if(!canvas) return
      const ctx = canvas.getContext("2d")
      const rect = canvas.getBoundingClientRect()
      const dpr = window.devicePixelRatio || 1
      canvas.width = Math.floor(rect.width * dpr)
      canvas.height = Math.floor(rect.height * dpr)
      ctx.scale(dpr, dpr)
      ctx.lineWidth = 2
      ctx.lineCap = "round"
      ctx.strokeStyle = "#0f172a"
      let drawing = false
      const pos = (e) => {
        const r = canvas.getBoundingClientRect()
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top
        return {x,y}
      }
      const start = (e) => {
        e.preventDefault()
        drawing = true
        const p = pos(e)
        ctx.beginPath()
        ctx.moveTo(p.x, p.y)
      }
      const move = (e) => {
        if(!drawing) return
        e.preventDefault()
        const p = pos(e)
        ctx.lineTo(p.x, p.y)
        ctx.stroke()
      }
      const end = (e) => {
        if(!drawing) return
        e.preventDefault()
        drawing = false
      }
      canvas.onmousedown = start
      canvas.onmousemove = move
      window.onmouseup = end
      canvas.ontouchstart = start
      canvas.ontouchmove = move
      canvas.ontouchend = end
    },
    clearSignature() {
      const canvas = document.getElementById("sigCanvas")
      if(!canvas) return
      const ctx = canvas.getContext("2d")
      ctx.clearRect(0, 0, canvas.width, canvas.height)
    },
    skipSignature() {
      this.signatureForm = { ...this.signatureForm, signature_b64: "" }
      this.showSignatureModal = false
      this.completeJobWithSignature(true)
    },
    async completeJobWithSignature(skip=false) {
      if(!this.activeJob?.id) return
      let sigB64 = ""
      if(!skip) {
        const canvas = document.getElementById("sigCanvas")
        if(canvas) sigB64 = canvas.toDataURL("image/png")
      }
      this.showSignatureModal = false
      const payload = {
        job_id: this.activeJob.id,
        final_items: this.activeJobItems,
        total: this.jobTotal,
        notes: this.activeJobNotes || "",
        signer_name: (this.signatureForm.signer_name || ""),
        signature_b64: sigB64 || ""
      }
      const res = await fetch("/api/jobs/complete", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      })
      if(res.ok) {
        this.notify("Work order completed", "Job closed successfully.", "success")
        await this.refreshMyJobs().catch(()=>{})
        await this.refreshDispatch().catch(()=>{})
        await this.refreshWorkorders().catch(()=>{})
        this.setView(this.user.role === 'admin' ? 'dispatch' : 'my-schedule')
      } else {
        this.notify("Completion failed", "Could not complete the work order.", "error")
      }
    },

async completeJob() {
      if(!confirm("Complete job and finalize invoice?")) return
      await fetch('/api/jobs/complete', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          job_id: this.activeJob.id,
          final_items: this.activeJobItems,
          total: this.activeJobTotal,
          notes: this.activeJobNotes
        })
      })
      this.notify("Work order completed", "Customer sign-off captured (if provided).", "success")
      this.activeJob = null
      this.activeJobItems = []
      this.activeJobNotes = ""
      if(this.user.role === 'tech') await this.setView('my-schedule')
      else await this.setView('dispatch')
    },

    // -------------------- Dispatch Assign (Scheduling) --------------------
    openAssignModal(job) {
      const today = new Date().toISOString().split('T')[0]
      this.assignForm = {
        quote_id: job.id,
        tech: "",
        date: job.scheduled_date || today,
        time: job.scheduled_time || "09:00",
        duration: 120
      }
      this.showAssignModal = true
    },
    async confirmAssign() {
      if(!this.assignForm.tech) return this.notify("Missing tech", "Select a technician to schedule.", "error")
      await fetch('/api/dispatch/assign', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          quote_id: this.assignForm.quote_id,
          tech_username: this.assignForm.tech,
          scheduled_date: this.assignForm.date,
          start_time: this.assignForm.time,
          duration_minutes: this.assignForm.duration
        })
      })
      this.showAssignModal = false
      await this.refreshDispatch()
    },

    // -------------------- Customers / Accounts --------------------
    openClientModal(client = null) {
      if (client) {
        this.isEditing = true
        this.formClient = { ...client }
      } else {
        this.isEditing = false
        this.formClient = { id: null, name: "", email: "", phone: "", address: "", city: "" }
      }
      this.showModal = true
    },
    async saveClient() {
      const url = this.isEditing ? `/api/customers/${this.formClient.id}` : '/api/customers'
      const method = this.isEditing ? 'PUT' : 'POST'
      await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(this.formClient) })
      this.showModal = false
      await this.initData()
      if(this.view === 'account-details' && this.accountSummary.customer?.id) await this.openAccount(this.accountSummary.customer.id)
    },
    async openAccount(customerId) {
      const res = await fetch(`/api/customers/${encodeURIComponent(customerId)}/summary`)
      this.accountSummary = await res.json()
      this.view = 'account-details'
    },

    // -------------------- Quote Builder --------------------
    addItem() {
      const item = this.selectedPart || this.selectedLabor
      if(!item) return
      const item_type = item.item_type || (item.category === 'Labor' ? 'Labor' : 'Part')
      this.cart.push({ ...item, item_type, note: '', qty: 1 })
      this.selectedPart = ''
      this.selectedLabor = ''
    },
    startNewQuote(prefCustomerId=null) {
      this.cart = []
      this.selectedCustomer = prefCustomerId || ""
      this.selectedPart = ""
      this.view = 'builder'
    },
    async saveQuote(status="Draft") {
      if(!this.selectedCustomer || !this.cart.length) return this.notify("Missing info", "Select a customer and add at least one line item.", "error")
      await fetch('/api/quotes', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          customer_id: this.selectedCustomer,
          items: this.cart,
          total: this.total,
          notes: "",
          status: status
        })
      })
      this.cart = []
      this.selectedCustomer = ""
      this.notify("Quote saved", "Quote created successfully.", "success")
      await this.refreshQuotes()
      this.view = 'quotes'
    },

    // -------------------- Quote Management --------------------
    async openQuote(quoteId) {
      const res = await fetch(`/api/quotes/${encodeURIComponent(quoteId)}`)
      const q = await res.json()
      this.activeQuote = { ...q, items: (q.items||[]).map(x => ({ ...x, qty: Number(x.qty||1), item_type: x.item_type || 'Part', note: x.note || '' })) }
      this.quoteSelectedPart = ""
      this.view = 'quote-details'
    },
    addQuoteItemToActive() {
      const item = this.quoteSelectedPart || this.quoteSelectedLabor
      if(!item) return
      const item_type = item.item_type || (item.category === 'Labor' ? 'Labor' : 'Part')
      this.activeQuote.items.push({ ...item, item_type, note: '', qty: 1 })
      this.quoteSelectedPart = ''
      this.quoteSelectedLabor = ''
    },
    async saveActiveQuote() {
      const total = this.quoteTotal(this.activeQuote.items)
      await fetch(`/api/quotes/${encodeURIComponent(this.activeQuote.id)}`, {
        method: 'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          items: this.activeQuote.items,
          total: total,
          notes: this.activeQuote.notes || "",
          status: this.activeQuote.status
        })
      })
      this.notify("Quote updated", "Changes saved successfully.", "success")
      await this.refreshQuotes()
      // If approved, refresh dispatch so it appears as schedulable job
      if(this.activeQuote.status === 'Approved') await this.refreshDispatch()
    },
    async quickSetQuoteStatus(quoteId, status, stay=false) {
      await fetch(`/api/quotes/${encodeURIComponent(quoteId)}/status`, {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status })
      })
      await this.refreshQuotes()
      if(status === 'Approved') await this.refreshDispatch()
      if(stay && this.view === 'quote-details') {
        this.activeQuote.status = status
      }
    },

    // -------------------- Service Call Creation --------------------
    openServiceCallModal(prefCustomerId=null) {
      this.serviceCallForm = { customer_id: prefCustomerId || "", title: "Service Call", address: "", notes: "" }
      this.showServiceCallModal = true
    },
    async createServiceCall() {
      if(!this.serviceCallForm.customer_id) return this.notify("Missing customer", "Select a customer first.", "error")
      await fetch('/api/service-calls', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          customer_id: this.serviceCallForm.customer_id,
          title: this.serviceCallForm.title,
          address: this.serviceCallForm.address,
          notes: this.serviceCallForm.notes,
          status: "New"
        })
      })
      this.showServiceCallModal = false
      await this.refreshDispatch()
      if(this.view === 'account-details' && this.accountSummary.customer?.id) await this.openAccount(this.accountSummary.customer.id)
    },
  },
  async mounted() {
    // optional: prefetch init data for quicker post-login
  }
}).mount('#app')
</script>

</body>
</html>
