<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeOps Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#2563EB', secondary: '#475569', surface: '#F8FAFC', success: '#10B981' }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-surface text-slate-800 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col" v-cloak>

    <div v-if="!user" class="fixed inset-0 bg-slate-100 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-primary text-white rounded-lg flex items-center justify-center mx-auto text-xl mb-2">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">TradeOps Login</h1>
                <p class="text-sm text-slate-500">Enter your credentials</p>
            </div>
            <form @submit.prevent="login">
                <input v-model="loginForm.username" class="w-full border p-3 rounded-lg mb-3" placeholder="Username (admin / tech)">
                <input v-model="loginForm.password" type="password" class="w-full border p-3 rounded-lg mb-4" placeholder="Password">
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-600 transition">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <div v-else class="flex h-full relative">
        
        <aside :class="mobileMenu ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" 
               class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 z-40 transition-transform duration-300 md:relative md:flex flex-col shadow-xl md:shadow-none">
            
            <div class="h-16 flex items-center px-6 border-b border-slate-100 justify-between">
                <div class="flex items-center font-bold text-lg tracking-tight">
                    <span class="text-primary mr-2"><i class="fa-solid fa-bolt"></i></span> TradeOps
                </div>
                <button @click="mobileMenu = false" class="md:hidden text-slate-400"><i class="fa-solid fa-times"></i></button>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                <a href="#" @click="setView('dashboard')" :class="navClass('dashboard')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard
                </a>
                
                <template v-if="user.role === 'admin'">
                    <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Management</div>
                    <a href="#" @click="setView('dispatch')" :class="navClass('dispatch')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-calendar-days w-5 text-center"></i> Dispatch Board
                    </a>
                    <a href="#" @click="setView('quotes')" :class="navClass('quotes')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> Quotes
                    </a>
                    <a href="#" @click="setView('builder')" :class="navClass('builder')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-pen-ruler w-5 text-center"></i> Builder
                    </a>
                    <a href="#" @click="setView('accounts')" :class="navClass('accounts')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-users w-5 text-center"></i> Customers
                    </a>
                </template>

                <template v-if="user.role === 'tech'">
                    <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Field Work</div>
                    <a href="#" @click="setView('my-schedule')" :class="navClass('my-schedule')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-calendar-check w-5 text-center"></i> My Schedule
                    </a>
                </template>
            </nav>

            <div class="p-4 border-t border-slate-100 flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">
                    {{ user.full_name.charAt(0) }}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm truncate">{{ user.full_name }}</div>
                    <div class="text-xs text-slate-400 capitalize">{{ user.role }}</div>
                </div>
                <button @click="logout" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-sign-out"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden w-full">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm shrink-0 z-10">
                <div class="flex items-center gap-3">
                    <button @click="mobileMenu = true" class="md:hidden text-slate-600 text-xl"><i class="fa-solid fa-bars"></i></button>
                    <h1 class="text-lg font-bold text-slate-800 capitalize">{{ view.replace('-', ' ') }}</h1>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-8 bg-surface">
                
                <div v-if="view === 'dashboard'" class="space-y-6 max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Revenue</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2">${{ dashboard.revenue.toLocaleString() }}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Active Jobs</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2">{{ dashboard.active_jobs }}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Pending Quotes</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2">{{ dashboard.pending }}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Avg Ticket</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2">${{ dashboard.avg_ticket.toFixed(0) }}</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Recent Activity</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-600 whitespace-nowrap">
                                    <thead class="bg-slate-50 text-xs uppercase text-slate-500"><tr><th class="px-6 py-3">Customer</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-right">Amount</th></tr></thead>
                                    <tbody>
                                        <tr v-for="item in dashboard.recent" :key="item.id" class="border-b border-slate-50">
                                            <td class="px-6 py-4 font-bold">{{ item.customer_name }}</td>
                                            <td class="px-6 py-4"><span class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100">{{ item.status }}</span></td>
                                            <td class="px-6 py-4 font-bold text-right">${{ item.total.toFixed(0) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Today's Schedule</div>
                            <div class="p-4 space-y-3 h-64 overflow-y-auto">
                                <div v-if="!dashboard.schedule.length" class="text-center text-slate-400 text-sm py-8">No jobs today.</div>
                                <div v-for="job in dashboard.schedule" class="border border-slate-100 rounded-lg p-3 bg-slate-50">
                                    <div class="flex justify-between font-bold text-sm"><span>{{ job.customer_name }}</span><span class="text-slate-500">{{ job.scheduled_date }}</span></div>
                                    <div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-user-gear mr-1"></i> {{ job.tech }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'dispatch'" class="max-w-7xl mx-auto h-[calc(100vh-8rem)] flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
                        <div class="p-4 border-b border-slate-100 bg-red-50 rounded-t-xl"><h3 class="font-bold text-red-700">Unscheduled Jobs ({{ dispatchData.unscheduled.length }})</h3></div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div v-if="!dispatchData.unscheduled.length" class="text-center text-slate-400 py-10 text-sm">All approved jobs scheduled!</div>
                            <div v-for="job in dispatchData.unscheduled" :key="job.id" class="border border-slate-200 rounded-lg p-4 bg-white shadow-sm">
                                <div class="flex justify-between items-start mb-2"><span class="font-bold text-slate-800">{{ job.customer_name }}</span><span class="bg-amber-100 text-amber-800 text-xs px-2 py-0.5 rounded-full font-bold">Approved</span></div>
                                <div class="text-xs text-slate-500 mb-3"><i class="fa-solid fa-location-dot mr-1"></i> {{ job.address }}</div>
                                <div class="flex justify-between items-center"><span class="font-bold text-slate-700">${{ job.total.toFixed(0) }}</span><button @click="openAssignModal(job)" class="bg-primary text-white px-3 py-1.5 rounded text-xs font-bold">Assign Tech</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl"><h3 class="font-bold text-slate-700">Technician Schedule</h3></div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div v-for="tech in dispatchData.techs" :key="tech.username" class="border border-slate-200 rounded-lg bg-slate-50">
                                    <div class="p-3 border-b border-slate-200 flex items-center gap-2 bg-white rounded-t-lg">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">{{ tech.full_name.charAt(0) }}</div>
                                        <span class="font-bold text-sm text-slate-700">{{ tech.full_name }}</span>
                                    </div>
                                    <div class="p-3 space-y-2 min-h-[100px]">
                                        <div v-for="job in getTechJobs(tech.username)" class="bg-white border border-slate-200 p-2 rounded text-sm shadow-sm">
                                            <div class="font-semibold">{{ job.customer_name }}</div>
                                            <div class="text-xs text-slate-500 flex justify-between mt-1"><span>{{ job.scheduled_date }}</span><span class="font-bold">${{ job.total.toFixed(0) }}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'my-schedule'" class="max-w-2xl mx-auto space-y-4">
                    <div v-for="job in myJobs" :key="job.id" class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="font-bold text-lg text-slate-800">{{ job.customer_name }}</h3><div class="text-sm text-slate-500">{{ job.address }}</div></div>
                            <div class="text-right"><div class="text-xs font-bold bg-blue-50 text-blue-700 px-2 py-1 rounded-full mb-1">{{ job.status }}</div><div class="text-sm font-bold text-slate-700">{{ job.scheduled_date }}</div></div>
                        </div>
                        <div class="border-t border-slate-100 pt-4 flex gap-2">
                            <button @click="openJobDetails(job)" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-600">
                                View & Start Job
                            </button>
                        </div>
                    </div>
                    <div v-if="myJobs.length === 0" class="text-center py-12 text-slate-400"><div class="text-4xl mb-2"><i class="fa-solid fa-mug-hot"></i></div><p>No jobs assigned to you.</p></div>
                </div>

                <div v-if="view === 'job-details'" class="max-w-3xl mx-auto">
                    <button @click="setView('my-schedule')" class="mb-4 text-slate-500 hover:text-primary font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> Back to Schedule</button>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="border-b border-slate-100 pb-4 mb-4">
                            <h2 class="text-xl font-bold text-slate-800">{{ activeJob.customer_name }}</h2>
                            <p class="text-sm text-slate-500">{{ activeJob.address }}</p>
                            <p class="text-sm text-slate-500 mt-1"><i class="fa-solid fa-phone"></i> {{ activeJob.phone }}</p>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-bold text-sm text-slate-400 uppercase mb-3">Work Order Items</h4>
                            <div v-for="(item, idx) in activeJobItems" :key="idx" class="flex justify-between items-center bg-slate-50 p-3 rounded mb-2 border border-slate-100">
                                <div>
                                    <div class="font-bold text-sm">{{ item.name }}</div>
                                    <div class="text-xs text-slate-500">${{ item.price }}</div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-sm font-bold">x{{ item.qty }}</span>
                                    <button @click="activeJobItems.splice(idx, 1)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <select v-model="selectedPart" class="flex-1 border p-2 rounded text-sm">
                                    <option value="" disabled>Add Part/Labor...</option>
                                    <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                                </select>
                                <button @click="addJobItem" class="bg-secondary text-white px-4 rounded text-sm font-bold">Add</button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-bold text-sm text-slate-400 uppercase mb-2">Completion Notes</h4>
                            <textarea v-model="activeJobNotes" class="w-full border rounded p-3 text-sm h-24" placeholder="Describe work done..."></textarea>
                        </div>

                        <div class="flex justify-between items-center border-t border-slate-100 pt-6">
                            <div class="text-right">
                                <div class="text-sm text-slate-500">Total Invoice</div>
                                <div class="text-2xl font-bold text-slate-800">${{ activeJobTotal.toFixed(2) }}</div>
                            </div>
                            <button @click="completeJob" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-green-500/30">
                                Complete Job
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'quotes'" class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500"><tr><th class="px-6 py-3">Customer</th><th class="px-6 py-3">Total</th><th class="px-6 py-3">Status</th></tr></thead>
                            <tbody>
                                <tr v-for="q in quotesList" class="border-b border-slate-50"><td class="px-6 py-4 font-bold">{{ q.customer_name }}</td><td class="px-6 py-4">${{ q.total.toFixed(2) }}</td><td class="px-6 py-4">{{ q.status }}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div v-if="view === 'accounts'" class="max-w-6xl mx-auto">
                    <div class="flex justify-end mb-4"><button @click="openClientModal()" class="bg-white border px-4 py-2 rounded shadow-sm text-sm font-bold">+ Add Account</button></div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500"><tr><th class="px-6 py-3">Name</th><th class="px-6 py-3">Action</th></tr></thead>
                            <tbody>
                                <tr v-for="c in customers" class="border-b border-slate-50"><td class="px-6 py-4 font-bold">{{ c.name }} <div class="text-xs text-slate-400 font-normal">{{ c.email }}</div></td><td class="px-6 py-4"><button @click="openClientModal(c)" class="text-primary text-xs font-bold hover:underline">Edit</button></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div v-if="view === 'builder'" class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold mb-4">New Quote</h3>
                        <div class="grid gap-4 mb-4">
                            <select v-model="selectedCustomer" class="w-full border p-2 rounded text-sm">
                                <option value="" disabled>Select Customer...</option>
                                <option v-for="c in customers" :key="c.id" :value="c.id">{{ c.name }}</option>
                            </select>
                            <div class="flex gap-2">
                                <select v-model="selectedPart" class="flex-1 border p-2 rounded text-sm">
                                    <option value="" disabled>Select Item...</option>
                                    <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} - ${{ p.price }}</option>
                                </select>
                                <button @click="addItem" class="bg-secondary text-white px-4 rounded text-sm">Add</button>
                            </div>
                        </div>
                        <div v-if="cart.length > 0" class="mb-4 bg-slate-50 p-4 rounded">
                            <div v-for="(item, idx) in cart" :key="idx" class="flex justify-between text-sm mb-1">
                                <span>{{ item.name }} (x1)</span><span class="font-bold">${{ item.price }}</span>
                            </div>
                            <div class="border-t pt-2 mt-2 flex justify-between font-bold"><span>Total</span><span>${{ total.toFixed(2) }}</span></div>
                        </div>
                        <button @click="saveQuote" class="w-full bg-primary text-white py-3 rounded font-bold">Save Quote</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div v-if="showAssignModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Assign Job</h3>
            <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Technician</label><select v-model="assignForm.tech" class="w-full border rounded p-2 text-sm"><option value="" disabled>Select Tech...</option><option v-for="t in dispatchData.techs" :value="t.username">{{ t.full_name }}</option></select></div>
            <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" v-model="assignForm.date" class="w-full border rounded p-2 text-sm"></div>
            <div class="flex justify-end gap-2"><button @click="showAssignModal = false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button><button @click="confirmAssign" class="px-4 py-2 bg-primary text-white rounded text-sm">Assign</button></div>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">{{ isEditing ? 'Edit' : 'New' }} Customer</h3>
            <input v-model="formClient.name" placeholder="Name" class="w-full border rounded p-2 mb-2 text-sm">
            <input v-model="formClient.email" placeholder="Email" class="w-full border rounded p-2 mb-2 text-sm">
            <input v-model="formClient.phone" placeholder="Phone" class="w-full border rounded p-2 mb-2 text-sm">
            <input v-model="formClient.address" placeholder="Address" class="w-full border rounded p-2 mb-4 text-sm">
            <div class="flex justify-end gap-2"><button @click="showModal = false" class="px-4 py-2 bg-slate-100 rounded text-sm">Cancel</button><button @click="saveClient" class="px-4 py-2 bg-primary text-white rounded text-sm">Save</button></div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                user: null,
                loginForm: { username: '', password: '' },
                view: 'dashboard',
                mobileMenu: false,
                dashboard: { revenue: 0, pending: 0, active_jobs: 0, avg_ticket: 0, recent: [], schedule: [] },
                dispatchData: { unscheduled: [], techs: [], scheduled: [] },
                myJobs: [],
                quotesList: [],
                customers: [],
                catalog: [],
                cart: [],
                selectedCustomer: "",
                selectedPart: "",
                
                // Active Job Logic
                activeJob: null,
                activeJobItems: [],
                activeJobNotes: "",
                
                showModal: false,
                isEditing: false,
                formClient: { id: null, name: "", email: "", phone: "", address: "" },
                showAssignModal: false,
                assignForm: { quote_id: null, tech: "", date: "" }
            }
        },
        computed: {
            total() { return this.cart.reduce((s, i) => s + (i.price * i.qty), 0) },
            activeJobTotal() { return this.activeJobItems.reduce((s, i) => s + (i.price * i.qty), 0) }
        },
        methods: {
            async login() {
                try {
                    const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.loginForm) })
                    if(!res.ok) throw new Error()
                    const data = await res.json()
                    this.user = data.user
                    this.initData()
                    this.refreshDashboard()
                } catch(e) { alert("Login failed") }
            },
            logout() { this.user = null; this.loginForm = {username:'', password:''} },
            navClass(v) { return this.view === v ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50' },
            async setView(v) {
                this.view = v
                this.mobileMenu = false
                if(v === 'dashboard') this.refreshDashboard()
                if(v === 'quotes') this.refreshQuotes()
                if(v === 'dispatch') this.refreshDispatch()
                if(v === 'my-schedule') this.refreshMyJobs()
            },
            async initData() {
                const res = await fetch('/api/init-data')
                const data = await res.json()
                this.customers = data.customers
                this.catalog = data.catalog
            },
            async refreshDashboard() { const res = await fetch('/api/dashboard'); this.dashboard = await res.json() },
            async refreshQuotes() { const res = await fetch('/api/quotes'); this.quotesList = await res.json() },
            async refreshDispatch() { const res = await fetch('/api/dispatch-data'); this.dispatchData = await res.json() },
            async refreshMyJobs() { const res = await fetch(`/api/my-jobs?username=${this.user.username}`); this.myJobs = await res.json() },
            getTechJobs(username) { return this.dispatchData.scheduled.filter(j => j.tech === username) },
            
            // --- ACTIVE JOB EXECUTION ---
            openJobDetails(job) {
                this.activeJob = job
                // Parse existing items
                try { this.activeJobItems = JSON.parse(job.items_json || "[]") } catch(e) { this.activeJobItems = [] }
                this.activeJobNotes = job.notes || ""
                this.view = 'job-details'
            },
            addJobItem() {
                if(!this.selectedPart) return
                this.activeJobItems.push({ ...this.selectedPart, qty: 1 })
            },
            async completeJob() {
                if(!confirm("Complete job and finalize invoice?")) return
                await fetch('/api/jobs/complete', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: this.activeJob.id,
                        final_items: this.activeJobItems,
                        total: this.activeJobTotal,
                        notes: this.activeJobNotes
                    })
                })
                alert("Job Completed!")
                this.activeJob = null
                this.setView('my-schedule')
            },

            // --- DISPATCH ASSIGN ---
            openAssignModal(job) { this.assignForm = { quote_id: job.id, tech: "", date: new Date().toISOString().split('T')[0] }; this.showAssignModal = true },
            async confirmAssign() {
                if(!this.assignForm.tech) return alert("Select a Tech")
                await fetch('/api/dispatch/assign', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ quote_id: this.assignForm.quote_id, tech_username: this.assignForm.tech, scheduled_date: this.assignForm.date }) })
                this.showAssignModal = false
                this.refreshDispatch()
            },
            
            // --- CUSTOMERS / QUOTES ---
            openClientModal(client = null) { if (client) { this.isEditing = true; this.formClient = { ...client }; } else { this.isEditing = false; this.formClient = { id: null, name: "", email: "", phone: "", address: "" }; } this.showModal = true },
            async saveClient() { const url = this.isEditing ? `/api/customers/${this.formClient.id}` : '/api/customers'; const method = this.isEditing ? 'PUT' : 'POST'; await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.formClient) }); this.showModal = false; this.initData() },
            addItem() { if(!this.selectedPart) return; this.cart.push({ ...this.selectedPart, qty: 1 }) },
            async saveQuote() { if(!this.selectedCustomer || !this.cart.length) return alert("Missing Info"); await fetch('/api/quotes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ customer_id: this.selectedCustomer, items: this.cart, total: this.total, notes: "" }) }); this.cart = []; this.selectedCustomer = ""; alert("Quote Saved") }
        }
    }).mount('#app')
</script>
</body>
</html>
