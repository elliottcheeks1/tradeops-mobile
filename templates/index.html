<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeOps Field</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563EB',
                        secondary: '#475569',
                        success: '#10B981',
                        surface: '#F8FAFC'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-surface text-slate-800 h-screen flex overflow-hidden">

<div id="app" class="flex w-full h-full">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20 shadow-sm transition-all duration-300">
        <div class="h-16 flex items-center px-6 border-b border-slate-100">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white mr-3">
                <i class="fa-solid fa-bolt"></i>
            </div>
            <span class="font-bold text-lg tracking-tight">TradeOps</span>
        </div>

        <div class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">
            Main
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a href="#"
               @click="setView('dashboard')"
               :class="view === 'dashboard' ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition">
                <i class="fa-solid fa-chart-pie w-5 text-center"></i>
                Dashboard
            </a>
            <a href="#"
               @click="setView('schedule')"
               :class="view === 'schedule' ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition">
                <i class="fa-solid fa-calendar-days w-5 text-center"></i>
                Schedule
            </a>

            <div class="pt-4 text-xs font-semibold text-slate-400 uppercase">
                Work
            </div>
            <a href="#"
               @click="setView('quotes')"
               :class="view === 'quotes' ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition">
                <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i>
                Quotes
            </a>
            <a href="#"
               @click="setView('builder')"
               :class="view === 'builder' ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition">
                <i class="fa-solid fa-pen-ruler w-5 text-center"></i>
                Builder
            </a>
            <a href="#"
               @click="setView('accounts')"
               :class="view === 'accounts' ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition">
                <i class="fa-solid fa-users w-5 text-center"></i>
                Customers
            </a>
        </nav>

        <div class="p-4 border-t border-slate-100 flex items-center gap-3 text-sm">
            <div class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center font-semibold text-slate-600">
                EC
            </div>
            <div class="leading-tight">
                <div class="font-semibold text-slate-800 text-sm">Elliott Cheeks</div>
                <div class="text-xs text-slate-400">Sr. Product Owner</div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <!-- TOP BAR -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10 shrink-0">
            <h1 class="text-xl font-bold text-slate-800">
                <span v-if="view === 'dashboard'">Dashboard Overview</span>
                <span v-else class="capitalize">{{ view }}</span>
            </h1>
            <div class="flex items-center gap-4">
                <div v-if="loading" class="loader"></div>
                <button @click="setView('builder')"
                        class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition">
                    + New Quote
                </button>
            </div>
        </header>

        <!-- BODY -->
        <div class="flex-1 overflow-auto p-8 relative">

            <!-- DASHBOARD VIEW -->
            <div v-if="view === 'dashboard'" class="space-y-6 max-w-6xl mx-auto">
                <!-- KPI CARDS -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-medium text-slate-500 uppercase">Total Revenue</p>
                        <div class="flex items-end justify-between mt-3">
                            <h3 class="text-3xl font-bold text-slate-800">${{ dashboard.revenue.toLocaleString() }}</h3>
                            <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-full">
                                +12.5%
                            </span>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-medium text-slate-500 uppercase">Active Jobs</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-3">{{ dashboard.active_jobs }}</h3>
                        <p class="text-xs text-slate-400 mt-1">
                            Technicians currently scheduled
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-medium text-slate-500 uppercase">Pending Quotes</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-3">{{ dashboard.pending }}</h3>
                        <p class="text-xs text-slate-400 mt-1">
                            In your sales pipeline
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-medium text-slate-500 uppercase">Avg Ticket</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-3">${{ dashboard.avg_ticket.toFixed(0) }}</h3>
                        <p class="text-xs text-slate-400 mt-1">
                            Last 30 days
                        </p>
                    </div>
                </div>

                <!-- RECENT + TODAY'S SCHEDULE LAYOUT -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Recent Activity -->
                    <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                            <div class="font-bold text-slate-700">Recent Activity</div>
                            <button @click="setView('quotes')" class="text-xs font-medium text-primary hover:underline">
                                View All
                            </button>
                        </div>
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                            <tr>
                                <th class="px-6 py-3">Customer</th>
                                <th class="px-6 py-3">Status</th>
                                <th class="px-6 py-3">Amount</th>
                                <th class="px-6 py-3">Created</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in dashboard.recent"
                                :key="item.id"
                                class="border-b border-slate-50">
                                <td class="px-6 py-4 font-medium text-slate-900">
                                    {{ item.name }}
                                </td>
                                <td class="px-6 py-4">
                                    <span
                                        class="text-xs font-semibold px-2 py-1 rounded-full"
                                        :class="item.status === 'Scheduled'
                                                ? 'bg-emerald-50 text-emerald-700'
                                                : (item.status === 'Draft'
                                                    ? 'bg-amber-50 text-amber-700'
                                                    : 'bg-blue-50 text-blue-700')">
                                        {{ item.status }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 font-bold">
                                    ${{ item.total.toFixed(2) }}
                                </td>
                                <td class="px-6 py-4 text-xs text-slate-400">
                                    {{ item.created_at }}
                                </td>
                            </tr>
                            <tr v-if="dashboard.recent.length === 0">
                                <td colspan="4" class="px-6 py-8 text-center text-slate-400 text-sm">
                                    No recent quotes yet.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">
                            Today's Schedule
                        </div>
                        <div class="p-4 space-y-3 max-h-80 overflow-y-auto">
                            <div v-if="dashboard.schedule.length === 0"
                                 class="text-sm text-slate-400 text-center py-6">
                                No jobs scheduled for today.
                            </div>
                            <div v-for="job in dashboard.schedule"
                                 :key="job.id"
                                 class="border border-slate-100 rounded-lg px-4 py-3 bg-slate-50">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-semibold text-slate-800">
                                        {{ job.name }}
                                    </span>
                                    <span class="text-xs text-slate-400">
                                        {{ job.scheduled_date || 'TBD' }}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-500">
                                    <span>
                                        <i class="fa-solid fa-user mr-1 text-primary"></i>
                                        {{ job.tech || 'Unassigned' }}
                                    </span>
                                    <span class="font-semibold text-slate-700">
                                        ${{ job.total.toFixed(2) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-3 border-t border-slate-100">
                            <button
                                @click="setView('schedule')"
                                class="w-full text-xs font-medium text-primary hover:underline">
                                View Full Calendar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QUOTES LIST -->
            <div v-if="view === 'quotes'" class="max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                        <tr>
                            <th class="px-6 py-3">Quote #</th>
                            <th class="px-6 py-3">Date</th>
                            <th class="px-6 py-3">Customer</th>
                            <th class="px-6 py-3 text-right">Amount</th>
                            <th class="px-6 py-3 text-center">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="q in quotesList" :key="q.id"
                            class="border-b border-slate-50 hover:bg-slate-50">
                            <td class="px-6 py-4 font-mono font-bold text-primary">{{ q.id }}</td>
                            <td class="px-6 py-4">{{ q.created_at }}</td>
                            <td class="px-6 py-4">{{ q.customer_name }}</td>
                            <td class="px-6 py-4 text-right font-bold">
                                ${{ q.total.toFixed(2) }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button class="text-slate-400 hover:text-primary">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        <tr v-if="quotesList.length === 0">
                            <td colspan="5" class="px-6 py-8 text-center text-slate-400 text-sm">
                                No quotes yet.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ACCOUNTS / CUSTOMERS -->
            <div v-if="view === 'accounts'" class="max-w-6xl mx-auto">
                <div class="flex justify-end mb-4">
                    <button @click="showModal = true"
                            class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 shadow-sm">
                        + Add Account
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                        <tr>
                            <th class="px-6 py-3">Name</th>
                            <th class="px-6 py-3">Type</th>
                            <th class="px-6 py-3">Address</th>
                            <th class="px-6 py-3">Contact</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="c in customers" :key="c.id" class="border-b border-slate-50">
                            <td class="px-6 py-4 font-medium text-slate-900">{{ c.name }}</td>
                            <td class="px-6 py-4">
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded">
                                    {{ c.type }}
                                </span>
                            </td>
                            <td class="px-6 py-4">{{ c.address }}</td>
                            <td class="px-6 py-4">{{ c.email }}</td>
                        </tr>
                        <tr v-if="customers.length === 0">
                            <td colspan="4" class="px-6 py-8 text-center text-slate-400 text-sm">
                                No customers yet. Add your first one with “+ Add Account”.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BUILDER -->
            <div v-if="view === 'builder'" class="max-w-6xl mx-auto grid grid-cols-12 gap-8">
                <div class="col-span-12 lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Customer</label>
                        <select v-model="selectedCustomer"
                                class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg p-2.5 mb-4">
                            <option value="" disabled>Select a client...</option>
                            <option v-for="c in customers" :key="c.id" :value="c.id">
                                {{ c.name }}
                            </option>
                        </select>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Notes</label>
                        <textarea v-model="notes" rows="4"
                                  class="block p-2.5 w-full text-sm bg-slate-50 rounded-lg border border-slate-300"></textarea>
                    </div>
                    <button @click="saveQuote"
                            class="w-full bg-success hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 transition">
                        Save Quote
                    </button>
                </div>

                <div class="col-span-12 lg:col-span-8 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 min-h-[500px] flex flex-col">
                        <div class="flex gap-2 mb-6">
                            <select v-model="selectedPart"
                                    class="flex-1 bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5">
                                <option value="" disabled>Add Item...</option>
                                <option v-for="p in catalog" :key="p.id" :value="p">
                                    {{ p.name }} — ${{ p.price }}
                                </option>
                            </select>
                            <input v-model.number="qtyInput" type="number" min="1"
                                   class="w-20 bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5 text-center">
                            <button @click="addItem"
                                    class="bg-secondary text-white rounded-lg px-5 text-sm font-medium">
                                Add
                            </button>
                        </div>

                        <table class="w-full text-sm text-left text-slate-600 mb-auto">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-400">
                            <tr>
                                <th class="px-4 py-2">Desc</th>
                                <th class="px-4 py-2 text-center">Qty</th>
                                <th class="px-4 py-2 text-right">Total</th>
                                <th class="px-4 py-2"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="(item, index) in cart" :key="index" class="border-b border-slate-50">
                                <td class="px-4 py-3 font-medium">{{ item.name }}</td>
                                <td class="px-4 py-3 text-center">{{ item.qty }}</td>
                                <td class="px-4 py-3 text-right font-bold">
                                    ${{ (item.price * item.qty).toFixed(2) }}
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button @click="removeItem(index)"
                                            class="text-red-400 hover:text-red-600">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="cart.length === 0">
                                <td colspan="4"
                                    class="px-4 py-8 text-center text-slate-400 text-sm">
                                    No items yet. Add parts or services from the dropdown above.
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <div class="border-t border-slate-100 pt-4 flex justify-between items-center">
                            <span class="text-slate-400 text-sm">{{ cart.length }} items</span>
                            <div class="text-right">
                                <p class="text-sm text-slate-500">
                                    Tax (8.25%): ${{ tax.toFixed(2) }}
                                </p>
                                <p class="text-2xl font-bold text-slate-800">
                                    Total: ${{ total.toFixed(2) }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIMPLE SCHEDULE VIEW (PLACEHOLDER) -->
            <div v-if="view === 'schedule'" class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold mb-2">Schedule</h2>
                    <p class="text-sm text-slate-500 mb-4">
                        Coming soon – for now, use the “Today’s Schedule” panel on the dashboard.
                    </p>
                </div>
            </div>

        </div>

        <!-- NEW ACCOUNT MODAL -->
        <div v-if="showModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 w-96">
                <h3 class="text-lg font-bold mb-4">New Account</h3>
                <input v-model="newClient.name" placeholder="Client Name"
                       class="w-full border rounded-lg p-2.5 mb-3 text-sm">
                <input v-model="newClient.email" placeholder="Email"
                       class="w-full border rounded-lg p-2.5 mb-3 text-sm">
                <input v-model="newClient.phone" placeholder="Phone"
                       class="w-full border rounded-lg p-2.5 mb-3 text-sm">
                <input v-model="newClient.address" placeholder="Address"
                       class="w-full border rounded-lg p-2.5 mb-4 text-sm">
                <div class="flex justify-end gap-2">
                    <button @click="showModal = false"
                            class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">
                        Cancel
                    </button>
                    <button @click="createClient"
                            class="px-4 py-2 text-sm bg-primary text-white rounded-lg">
                        Save
                    </button>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                view: 'dashboard',
                loading: false,
                customers: [],
                catalog: [],
                cart: [],
                quotesList: [],
                dashboard: {
                    revenue: 0,
                    pending: 0,
                    active_jobs: 0,
                    avg_ticket: 0,
                    recent: [],
                    schedule: []
                },
                selectedCustomer: "",
                selectedPart: "",
                qtyInput: 1,
                notes: "",
                showModal: false,
                newClient: { name: "", type: "Commercial", email: "", phone: "", address: "" }
            }
        },
        computed: {
            subtotal() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0)
            },
            tax() { return this.subtotal * 0.0825 },
            total() { return this.subtotal + this.tax }
        },
        mounted() {
            this.initData()
            this.refreshDashboard()
        },
        methods: {
            async setView(viewName) {
                this.view = viewName
                if (viewName === 'dashboard') this.refreshDashboard()
                if (viewName === 'quotes') this.refreshQuotes()
                if (viewName === 'accounts') this.initData()
            },
            async initData() {
                this.loading = true
                const res = await fetch('/api/init-data')
                const data = await res.json()
                this.customers = data.customers
                this.catalog = data.catalog
                this.loading = false
            },
            async refreshDashboard() {
                const res = await fetch('/api/dashboard')
                this.dashboard = await res.json()
            },
            async refreshQuotes() {
                const res = await fetch('/api/quotes')
                this.quotesList = await res.json()
            },
            addItem() {
                if (!this.selectedPart) return
                this.cart.push({
                    id: this.selectedPart.id,
                    name: this.selectedPart.name,
                    price: this.selectedPart.price,
                    qty: this.qtyInput || 1
                })
                this.selectedPart = ""
                this.qtyInput = 1
            },
            removeItem(index) {
                this.cart.splice(index, 1)
            },
            async createClient() {
                if (!this.newClient.name) return
                this.loading = true
                await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newClient)
                })
                await this.initData()       // refresh customer list
                this.showModal = false
                this.newClient = { name: "", type: "Commercial", email: "", phone: "", address: "" }
                this.loading = false
            },
            async saveQuote() {
                if (!this.selectedCustomer) {
                    alert("Select a client first.")
                    return
                }
                if (this.cart.length === 0) {
                    alert("Add at least one line item.")
                    return
                }
                this.loading = true
                const payload = {
                    customer_id: this.selectedCustomer,
                    items: this.cart,
                    total: this.total,
                    notes: this.notes
                }
                await fetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                alert("Quote Saved!")
                this.cart = []
                this.selectedCustomer = ""
                this.notes = ""
                this.loading = false
                this.setView('quotes')
            }
        }
    }).mount('#app')
</script>

</body>
</html>
