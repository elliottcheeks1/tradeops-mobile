<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeOps Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#2563EB', surface: '#F8FAFC' }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-surface text-slate-800 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col" v-cloak>

    <div v-if="!user" class="fixed inset-0 bg-slate-100 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-primary text-white rounded-lg flex items-center justify-center mx-auto text-xl mb-2">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">TradeOps Login</h1>
                <p class="text-sm text-slate-500">Enter your credentials</p>
            </div>
            <form @submit.prevent="login">
                <input v-model="loginForm.username" class="w-full border p-3 rounded-lg mb-3" placeholder="Username (admin or tech)">
                <input v-model="loginForm.password" type="password" class="w-full border p-3 rounded-lg mb-4" placeholder="Password">
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-600 transition">
                    Sign In
                </button>
            </form>
            <div class="mt-4 text-xs text-center text-slate-400">
                Try: <b>admin / admin</b> or <b>tech / tech</b>
            </div>
        </div>
    </div>

    <div v-else class="flex h-full relative">
        
        <div v-if="mobileMenu" @click="mobileMenu = false" class="fixed inset-0 bg-black/50 z-30 md:hidden"></div>

        <aside :class="mobileMenu ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" 
               class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 z-40 transition-transform duration-300 md:relative md:flex flex-col shadow-xl md:shadow-none">
            
            <div class="h-16 flex items-center px-6 border-b border-slate-100 justify-between">
                <div class="flex items-center font-bold text-lg tracking-tight">
                    <span class="text-primary mr-2"><i class="fa-solid fa-bolt"></i></span> TradeOps
                </div>
                <button @click="mobileMenu = false" class="md:hidden text-slate-400"><i class="fa-solid fa-times"></i></button>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                <a href="#" @click="setView('dashboard')" :class="navClass('dashboard')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard
                </a>

                <template v-if="user.role === 'admin'">
                    <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Management</div>
                    <a href="#" @click="setView('quotes')" :class="navClass('quotes')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> Quotes
                    </a>
                    <a href="#" @click="setView('builder')" :class="navClass('builder')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-pen-ruler w-5 text-center"></i> Builder
                    </a>
                    <a href="#" @click="setView('accounts')" :class="navClass('accounts')" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg">
                        <i class="fa-solid fa-users w-5 text-center"></i> Customers
                    </a>
                </template>

                <template v-if="user.role === 'tech'">
                    <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Field Work</div>
                    <a href="#" class="flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50">
                        <i class="fa-solid fa-calendar-check w-5 text-center"></i> My Schedule
                    </a>
                </template>
            </nav>

            <div class="p-4 border-t border-slate-100 flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">
                    {{ user.full_name.charAt(0) }}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm truncate">{{ user.full_name }}</div>
                    <div class="text-xs text-slate-400 capitalize">{{ user.role }}</div>
                </div>
                <button @click="logout" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-sign-out"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden w-full">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm shrink-0 z-10">
                <div class="flex items-center gap-3">
                    <button @click="mobileMenu = true" class="md:hidden text-slate-600 text-xl">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h1 class="text-lg font-bold text-slate-800 capitalize">{{ view }}</h1>
                </div>
                <div v-if="user.role === 'admin'" class="flex items-center gap-2">
                    <button @click="setView('builder')" class="bg-primary text-white w-8 h-8 md:w-auto md:px-4 md:py-2 rounded-full md:rounded-lg text-sm font-medium shadow-sm flex items-center justify-center">
                        <span class="md:hidden"><i class="fa-solid fa-plus"></i></span>
                        <span class="hidden md:inline">+ Quote</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-8 bg-surface">
                
                <div v-if="view === 'dashboard'" class="space-y-6 max-w-6xl mx-auto">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Revenue</p>
                            <h3 class="text-xl md:text-2xl font-bold text-slate-800">${{ dashboard.revenue.toLocaleString() }}</h3>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400 uppercase">Pending</p>
                            <h3 class="text-xl md:text-2xl font-bold text-slate-800">{{ dashboard.pending }}</h3>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-700">Recent Activity</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600 whitespace-nowrap">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                                    <tr>
                                        <th class="px-6 py-3">Customer</th>
                                        <th class="px-6 py-3">Total</th>
                                        <th class="px-6 py-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in dashboard.recent" :key="item.id" class="border-b border-slate-50">
                                        <td class="px-6 py-3 font-medium">{{ item.name }}</td>
                                        <td class="px-6 py-3">${{ item.total.toFixed(0) }}</td>
                                        <td class="px-6 py-3">
                                            <span class="text-xs font-bold px-2 py-1 rounded-full bg-blue-50 text-blue-700">{{ item.status }}</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'quotes'" class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600 whitespace-nowrap">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                                    <tr>
                                        <th class="px-6 py-3">Customer</th>
                                        <th class="px-6 py-3">Total</th>
                                        <th class="px-6 py-3">Status (Edit)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="q in quotesList" :key="q.id" class="border-b border-slate-50">
                                        <td class="px-6 py-4">
                                            <div class="font-medium text-slate-900">{{ q.customer_name }}</div>
                                            <div class="text-xs text-slate-400">{{ q.created_at }}</div>
                                        </td>
                                        <td class="px-6 py-4 font-bold">${{ q.total.toFixed(2) }}</td>
                                        <td class="px-6 py-4">
                                            <select @change="updateStatus(q.id, $event.target.value)" 
                                                    :value="q.status"
                                                    class="bg-slate-50 border border-slate-200 text-xs rounded p-1">
                                                <option value="Draft">Draft</option>
                                                <option value="Approved">Approved</option>
                                                <option value="Completed">Completed</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'accounts'" class="max-w-6xl mx-auto">
                    <div class="flex justify-end mb-4">
                        <button @click="openClientModal()" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 shadow-sm">
                            + Add Account
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600 whitespace-nowrap">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                                    <tr>
                                        <th class="px-6 py-3">Name</th>
                                        <th class="px-6 py-3">Info</th>
                                        <th class="px-6 py-3 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in customers" :key="c.id" class="border-b border-slate-50 hover:bg-slate-50">
                                        <td class="px-6 py-4 font-bold text-slate-700">{{ c.name }}</td>
                                        <td class="px-6 py-4 text-xs">
                                            <div>{{ c.email }}</div>
                                            <div class="text-slate-400">{{ c.phone }}</div>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="openClientModal(c)" class="text-primary text-xs font-bold hover:underline">Edit</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'builder'" class="max-w-6xl mx-auto grid grid-cols-1 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Customer</label>
                        <select v-model="selectedCustomer" class="w-full bg-slate-50 border p-2 rounded-lg mb-4 text-sm">
                            <option value="" disabled>Select Client...</option>
                            <option v-for="c in customers" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        
                        <div class="flex gap-2 mb-4">
                            <select v-model="selectedPart" class="flex-1 bg-slate-50 border p-2 rounded-lg text-sm">
                                <option value="" disabled>Part...</option>
                                <option v-for="p in catalog" :key="p.id" :value="p">{{ p.name }} (${{p.price}})</option>
                            </select>
                            <button @click="addItem" class="bg-secondary text-white px-4 rounded-lg text-sm">Add</button>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div v-for="(item, idx) in cart" :key="idx" class="flex justify-between text-sm border-b pb-2">
                                <span>{{ item.name }} (x{{item.qty}})</span>
                                <span class="font-bold">${{ (item.price * item.qty).toFixed(2) }}</span>
                            </div>
                            <div v-if="cart.length===0" class="text-center text-slate-400 text-sm py-4">Cart empty</div>
                        </div>

                        <button @click="saveQuote" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold">
                            Save Quote (${{ total.toFixed(0) }})
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">{{ isEditing ? 'Edit' : 'New' }} Account</h3>
            <input v-model="formClient.name" placeholder="Name" class="w-full border rounded-lg p-2 mb-2 text-sm">
            <input v-model="formClient.email" placeholder="Email" class="w-full border rounded-lg p-2 mb-2 text-sm">
            <input v-model="formClient.phone" placeholder="Phone" class="w-full border rounded-lg p-2 mb-2 text-sm">
            <input v-model="formClient.address" placeholder="Address" class="w-full border rounded-lg p-2 mb-4 text-sm">
            <div class="flex justify-end gap-2">
                <button @click="showModal = false" class="px-4 py-2 text-sm text-slate-600 bg-slate-100 rounded-lg">Cancel</button>
                <button @click="saveClient" class="px-4 py-2 text-sm bg-primary text-white rounded-lg">Save</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                user: null, // { username, role, full_name }
                loginForm: { username: '', password: '' },
                view: 'dashboard',
                mobileMenu: false,
                dashboard: { revenue: 0, pending: 0, recent: [] },
                quotesList: [],
                customers: [],
                catalog: [],
                cart: [],
                // Builder Data
                selectedCustomer: "",
                selectedPart: "",
                // Modal Data
                showModal: false,
                isEditing: false,
                formClient: { id: null, name: "", email: "", phone: "", address: "" }
            }
        },
        computed: {
            total() { return this.cart.reduce((s, i) => s + (i.price * i.qty), 0) }
        },
        methods: {
            async login() {
                try {
                    const res = await fetch('/api/login', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.loginForm)
                    })
                    if(!res.ok) throw new Error()
                    const data = await res.json()
                    this.user = data.user
                    this.initData()
                    this.refreshDashboard()
                } catch(e) { alert("Login failed") }
            },
            logout() { this.user = null; this.loginForm = {username:'', password:''} },
            navClass(v) {
                return this.view === v ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'
            },
            async setView(v) {
                this.view = v
                this.mobileMenu = false
                if(v === 'dashboard') this.refreshDashboard()
                if(v === 'quotes') this.refreshQuotes()
            },
            async initData() {
                const res = await fetch('/api/init-data')
                const data = await res.json()
                this.customers = data.customers
                this.catalog = data.catalog
            },
            async refreshDashboard() {
                const res = await fetch('/api/dashboard')
                this.dashboard = await res.json()
            },
            async refreshQuotes() {
                const res = await fetch('/api/quotes')
                this.quotesList = await res.json()
            },
            // --- EDITING & SAVING CUSTOMERS ---
            openClientModal(client = null) {
                if (client) {
                    this.isEditing = true
                    this.formClient = { ...client }
                } else {
                    this.isEditing = false
                    this.formClient = { id: null, name: "", email: "", phone: "", address: "" }
                }
                this.showModal = true
            },
            async saveClient() {
                const url = this.isEditing ? `/api/customers/${this.formClient.id}` : '/api/customers'
                const method = this.isEditing ? 'PUT' : 'POST'
                await fetch(url, {
                    method: method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.formClient)
                })
                this.showModal = false
                this.initData()
            },
            // --- QUOTES ---
            async updateStatus(id, newStatus) {
                await fetch(`/api/quotes/${id}/status`, {
                    method: 'PUT', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: newStatus })
                })
                this.refreshQuotes()
            },
            addItem() {
                if(!this.selectedPart) return
                this.cart.push({ ...this.selectedPart, qty: 1 })
            },
            async saveQuote() {
                if(!this.selectedCustomer || !this.cart.length) return alert("Missing Info")
                await fetch('/api/quotes', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        customer_id: this.selectedCustomer, items: this.cart, total: this.total
                    })
                })
                this.cart = []
                this.selectedCustomer = ""
                alert("Quote Saved")
            }
        }
    }).mount('#app')
</script>
</body>
</html>
